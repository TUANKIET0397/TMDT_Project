{{! Detail product }}
{{#contentFor "styles"}}
<link rel="stylesheet" href="/css/detail.css" />
{{/contentFor}}

<!-- Detail section content -->
<section class="section">
    <div class="container">
        <div class="section__inner">
            <!-- LEFT section: 6 ·∫£nh grid -->
            <div class="section__hero-left">
                {{#each product.Images6}}
                <div class="section__hero-item">
                    <img src="{{this}}" alt="{{../product.ProductName}}" />
                </div>
                {{/each}}
            </div>

            <!-- RIGHT section: Product info from backend -->
            <div
                class="section__content-right product-detail"
                data-product-id="{{product.ID}}"
                data-product-name="{{product.ProductName}}"
                data-product-price="{{product.Price}}"
                data-product-image="{{product.ImgPath}}">
                <p class="section__label">{{product.TypeName}}</p>
                <h2 class="section__heading">{{product.ProductName}}</h2>
                <p class="section__price">${{product.Price}}</p>

                <div class="section__aside">
                    <p class="section__aside-price">
                        or 4 times
                        {{divide product.Price 4}}
                        ‚Ç¨
                    </p>
                    <span class="section__aside-size">
                        What's my size?
                    </span>
                </div>

                <!-- form size - ·∫®N M·∫∂C ƒê·ªäNH, CH·ªà HI·ªÜN KHI CH·ªåN M√ÄU -->
                <div class="section__form" role="list" id="sizesContainer" style="{{#if colors}}display:none;{{/if}}">
                    <!-- Sizes s·∫Ω ƒë∆∞·ª£c inject b·ªüi JavaScript khi ch·ªçn m√†u -->
                </div>

                {{#unless colors}}
                <!-- N·∫æU KH√îNG C√ì COLORS (s·∫£n ph·∫©m 1 m√†u), HI·ªÇN th·ªã sizes m·∫∑c ƒë·ªãnh -->
                <div class="section__form" role="list" id="sizesContainer">
                    {{#each defaultSizes}}
                    <div class="section__form-button">
                        <div role="button" tabindex="0"
                            class="section__form-size {{#if ../isShoes}}section__form-size--numeric{{/if}}"
                            data-size="{{this.SizeName}}"
                            data-size-id="{{this.ID}}">
                            {{this.SizeName}}
                        </div>
                        <div class="section__form-quantity" data-size-id="{{this.ID}}">
                            <h5>SL: {{this.QuantityValue}}</h5>
                        </div>
                    </div>
                    {{/each}}
                </div>
                {{/unless}}

                <!-- btn add to cart & buy now -->
                <div class="section_btn-detail">
                    <div
                        class="btn section__btn-add"
                        id="addToCartBtn"
                        >ADD TO CART - M</div>
                    <div class="btn section__btn-buy" id="buyNowBtn">BUY
                        NOW</div>
                    <button
                        type="button"
                        class="btn section_btn-advise btn-consult">GET
                        ADVISE</button>
                    <p class="section__label section__label--other">OTHER
                        COLORS</p>
                </div>
                <div class="section__other-color">
                    {{#each product.ImagesByColorList}}
                    <!-- th√™m class 'color-group' v√† data-color ƒë·ªÉ JS nh·∫≠n bi·∫øt -->
                    <div class="color-images color-group"
                        data-color="{{this.color}}" role="button" tabindex="0">
                        <div class="label_color-img">{{this.color}}</div>
                        {{#each this.images6}}
                        <img class="color-img" src="{{this}}"
                            alt="{{../product.ProductName}}" />
                        {{/each}}
                    </div>
                    {{/each}}
                </div>
                <!-- Description from backend -->
                <div class="section__desc">
                    <p class="section__desc--inf">Korean niche brand,
                        specialized in the manufacture of denim pieces, Demil
                        MFG offers demanding creations, inspired by the
                        reproduction of archival clothing and driven by a
                        constant quest for excellence.
                    </p>
                    <h3 class="section__desc--heading">WHAT CONVINDED US</h3>
                    <p class="section__desc--inf">Faithful reproduction of the
                        legendary Type II Trucker Jacket, born in the early 50s,
                        the Pioneer Jacket displays a boxy silhouette and a
                        resolutely retro spirit.
                    </p>
                    <p class="section__desc--inf">Crafted in a 13oz selvedge
                        fabric developed exclusively by Demil MFG‚Äîfrom an
                        archive of exceptional fabrics ‚Äî it embodies all the
                        know-how of old-fashioned manufacturing, combining high
                        standards and tradition.
                    </p>
                    <p class="section__desc--inf">With its raw color, authentic
                        canvas and vintage fit, the Pioneer Jacket stands out as
                        one of the best value for money in its class. A piece of
                        character, designed to age with time and enhance your
                        layering games, season after season.
                    </p>
                    <div class="section__desc--details">
                        <p class="section__desc--highlight">Available
                            exclusively in Europe on shoppmall</p>

                        <!-- item 1-->
                        <div class="section__desc--wrap">
                            <p class="section__desc--item">DETAIL</p>
                            <svg
                                width="16"
                                height="9"
                                viewBox="0 0 16 9"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M15 1L8 8L1 1"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <!-- item 2-->
                        <div class="section__desc--wrap">
                            <p class="section__desc--item">FIT</p>
                            <svg
                                width="16"
                                height="9"
                                viewBox="0 0 16 9"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M15 1L8 8L1 1"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <!-- item 3-->
                        <div class="section__desc--wrap">
                            <p class="section__desc--item">DELIVERY AND
                                RETURN</p>
                            <svg
                                width="16"
                                height="9"
                                viewBox="0 0 16 9"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M15 1L8 8L1 1"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <!-- item 4-->
                        <div class="section__desc--wrap">
                            <p class="section__desc--item">CARE GUIDE</p>
                            <svg
                                width="16"
                                height="9"
                                viewBox="0 0 16 9"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M15 1L8 8L1 1"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Products Section (n·ªëi backend) -->

<section class="about">
    <div class="container">
        <h2 class="about__intro">ABOUT THE BRAND</h2>
        <!-- top -->
        <div class="about__inner-top">
            <!-- Item 1 -->
            <div class="about__inner-item">
                <h2 class="about__heading">Gucci NMT</h2>
                <!-- info item 1 -->
                <div class="about__info-item">
                    <p>Creation
                        year....................................................................2018</p>
                    <p>City of
                        origin.....................................................................Seoul</p>
                    <p>Founder(s).....................................................Ham
                        Dong-soo</p>
                </div>

            </div>
            <!-- Item 2 -->
            <div class="about__inner-item">
                <p class="about__desc about__desc-edit">
                    Confidential Korean label, Demil MFG is distinguished by its
                    expertise in the manufacture of denim pieces with an
                    assertive character. Nurtured by the study of archival
                    clothing, the brand develops cutting-edge creations, guided
                    by a constant demand for quality.
                </p>
                <p class="about__desc about__desc-edit">With an approach that is
                    both nerdy and meticulous, the brand strives to offer
                    aesthetic and timeless pieces, shaped with particular
                    attention to detail.
                </p>
            </div>
            <!-- Item 3 -->
            <div class="about__inner-item">
                <h2 class="about__heading">Must read</h2>
                <div class="about__guide-link">
                    <img
                        class="about__guide-link--img"
                        src="./assets/icons/youtube.png"
                        alt="Youtube" />
                    <div
                        class="about__guide-slogan clamp-text"
                        style="--content-slogan: 'Youtube'; --line-count: 4">
                        Gucci guide to everyone [matching with your styles]
                    </div>
                    <div class="about__guide-link--btn">EN</div>
                </div>
                <h2 class="about__heading about__heading-other">Best
                    sellers</h2>
                <!-- Best sellers -->
                <div class="about__list-aside">
                    <!-- item sub 1-->
                    <div class="about__list-item">
                        <div
                            class="about__list-item__number"
                            style="--number-bestSeller:'1'"></div>
                        <div class="about__list-item--wrap">
                            <p class="about__list-item__name">Jean 'Pioneer
                                Pants' - Raw</p>
                            <p class="about__list-item__desc">Raw Selvedge
                                Denim</p>
                        </div>
                    </div>
                    <!-- item sub 2-->
                    <div class="about__list-item">
                        <div
                            class="about__list-item__number"
                            style="--number-bestSeller:'2'"></div>
                        <div class="about__list-item--wrap">
                            <p class="about__list-item__name">Jean 'Pioneer
                                Pants' - Raw</p>
                            <p class="about__list-item__desc">Raw Selvedge
                                Denim</p>
                        </div>
                    </div>
                    <!-- item sub 3-->
                    <div class="about__list-item">
                        <div
                            class="about__list-item__number"
                            style="--number-bestSeller:'3'"></div>
                        <div class="about__list-item--wrap">
                            <p class="about__list-item__name">Jean 'Pioneer
                                Pants' - Raw</p>
                            <p class="about__list-item__desc">Raw Selvedge
                                Denim</p>
                        </div>
                    </div>
                    <!-- item sub 4-->
                    <div class="about__list-item">
                        <div
                            class="about__list-item__number"
                            style="--number-bestSeller:'4'"></div>
                        <div class="about__list-item--wrap">
                            <p class="about__list-item__name">Jean 'Pioneer
                                Pants' - Raw</p>
                            <p class="about__list-item__desc">Raw Selvedge
                                Denim</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Item 4 -->
            <div class="about__inner-item"></div>
            {{#if relatedProducts}}
            {{#each relatedProducts}}
            <div class="about__inner-wrap">
                <a
                    href="/products/detail/{{this.ID}}"
                    style="text-decoration: none; color: inherit; cursor: pointer;">
                    <div class="about__inner-item">
                        <div class="about__item-bottom">
                            <div class="about__item-bottom-img">
                                <div
                                    class="about__item-bottom-img-main">
                                    <img
                                        src="{{this.ImgPath}}"
                                        alt="{{this.ProductName}}" />
                                    <div
                                        class="about__item-bottom-list">
                                        <div
                                            class="about__item-bottom-list-edit">u</div>
                                        <div>u</div>
                                        <div>u</div>
                                    </div>
                                    <div
                                        class="about__item-bottom--new">{{this.IsNew}}</div>
                                </div>
                            </div>
                            <div class="about__item-bottom-aside">
                                <div class="about__item-bottom-label">
                                    <h2
                                        class="about__item-bottom-heading">{{this.ProductName}}</h2>
                                    <div
                                        class="about__item-bottom-price">${{this.Price}}</div>
                                </div>
                                <div class="about__item-bottom-desc">
                                    {{#if
                                    this.ShortDesc
                                    }}{{this.ShortDesc}}{{else}}Type II
                                    Trucker Jacket 'Pioneer Jacket'
                                    - Raw Selvedge Denim{{/if}}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            {{/each}}
            {{/if}}
        </div>
    </div>
</section>

<script>
(function () {
  document.addEventListener('DOMContentLoaded', function () {
    try {
      const contentEl = document.querySelector('.section__content-right')
      const productId = contentEl?.dataset.productId ?? '{{product.ID}}'
      const productName = contentEl?.dataset.productName ?? '{{product.ProductName}}'
      const productPrice = Number(contentEl?.dataset.productPrice) || Number({{product.Price}}) || 0
      const productImg = contentEl?.dataset.productImage ?? '{{product.ImgPath}}'
      const isShoes = {{#if isShoes}}true{{else}}false{{/if}}

      const colorSizesMap = {{{colorSizesMapJSON}}} || {}
      console.log('üé® colorSizesMap:', colorSizesMap)
      console.log('üîë Available colors:', Object.keys(colorSizesMap))

      let selectedSize = null
      let selectedSizeId = null
      let selectedColor = null

      const addBtn = document.getElementById('addToCartBtn')
      const buyBtn = document.getElementById('buyNowBtn')
      const sizesContainer = document.getElementById('sizesContainer')

      function showDialog(message) {
        const existing = document.getElementById('tm-dialog')
        if (existing) existing.remove()
        const dlg = document.createElement('div')
        dlg.id = 'tm-dialog'
        dlg.style = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:9999'
        dlg.innerHTML = `
          <div role="dialog" aria-modal="true" style="background:#fff;padding:18px;border-radius:6px;max-width:420px;width:90%;box-shadow:0 6px 24px rgba(0,0,0,0.15);text-align:center">
            <p style="margin:0 0 12px;color:#111;font-size:15px">${String(message)}</p>
            <button id="tm-dialog-ok" style="background:#2d6cdf;color:#fff;border:0;padding:8px 14px;border-radius:4px;cursor:pointer">OK</button>
          </div>`
        document.body.appendChild(dlg)
        document.getElementById('tm-dialog-ok').focus()
        document.getElementById('tm-dialog-ok').addEventListener('click', () => dlg.remove())
      }

      function renderSizesForColor(colorName) {
        if (!sizesContainer) return
        
        console.log('üìè Rendering sizes for color:', colorName)
        
        const data = colorSizesMap[colorName]
        if (!data || !data.sizes || data.sizes.length === 0) {
          console.warn('‚ö†Ô∏è No sizes found for color:', colorName)
          sizesContainer.innerHTML = '<p style="color:#999;font-size:14px;padding:10px;">No sizes available for this color</p>'
          sizesContainer.style.display = 'block'
          selectedSize = null
          selectedSizeId = null
          updateActionButtons()
          return
        }

        const sizes = data.sizes
        console.log('‚úÖ Found sizes:', sizes)
        let html = ''
        
        sizes.forEach(size => {
          const sizeClass = isShoes ? 'section__form-size--numeric' : ''
          html += `
            <div class="section__form-button">
              <div role="button" tabindex="0"
                  class="section__form-size ${sizeClass}"
                  data-size="${size.SizeName}"
                  data-size-id="${size.ID}">
                ${size.SizeName}
              </div>
              <div class="section__form-quantity" data-size-id="${size.ID}">
                <h5>SL: ${size.QuantityValue}</h5>
              </div>
            </div>
          `
        })

        sizesContainer.innerHTML = html
        sizesContainer.style.display = 'flex'
        
        selectedSize = null
        selectedSizeId = null
        if (addBtn) addBtn.textContent = 'ADD TO CART'
        
        attachSizeHandlers()
        updateActionButtons()
      }

      function attachSizeHandlers() {
        document.querySelectorAll('.section__form-size').forEach(btn => {
          const newBtn = btn.cloneNode(true)
          btn.parentNode.replaceChild(newBtn, btn)
          
          newBtn.addEventListener('click', function () {
            document.querySelectorAll('.section__form-button').forEach(pb => pb.classList.remove('active'))
            document.querySelectorAll('.section__form-size').forEach(b => {
              b.classList.remove('active')
              b.setAttribute('aria-pressed', 'false')
            })

            const parent = this.closest('.section__form-button')
            if (parent) parent.classList.add('active')
            this.classList.add('active')
            this.setAttribute('aria-pressed', 'true')

            selectedSize = this.dataset.size || null
            selectedSizeId = this.dataset.sizeId || null

            if (addBtn) addBtn.textContent = `ADD TO CART - ${selectedSize || ''}`
            updateActionButtons()
          })

          newBtn.addEventListener('keydown', function (ev) {
            if (ev.key === 'Enter' || ev.key === ' ') {
              ev.preventDefault()
              this.click()
            }
          })
        })
      }

      function updateActionButtons() {
        const hasColorOptions = document.querySelectorAll('.color-group').length > 0
        const okSize = !!selectedSize
        const okColor = !hasColorOptions || !!selectedColor
        const enabled = okSize && okColor

        if (addBtn) {
          addBtn.setAttribute('aria-disabled', String(!enabled))
          addBtn.classList.toggle('disabled', !enabled)
        }
        if (buyBtn) {
          buyBtn.setAttribute('aria-disabled', String(!enabled))
          buyBtn.classList.toggle('disabled', !enabled)
        }
      }

      document.addEventListener('click', function (ev) {
        const el = ev.target.closest('.color-group')
        if (!el) return
        ev.preventDefault()
        
        document.querySelectorAll('.color-group').forEach(b => b.classList.remove('active'))
        el.classList.add('active')
        selectedColor = el.dataset.color || null

        if (Object.keys(colorSizesMap).length > 0) {
          renderSizesForColor(selectedColor)
        }

        const colorSrcs = Array.from(el.querySelectorAll('.color-img'))
          .map(img => img.dataset.src || img.src)
          .filter(Boolean)

        const heroItems = Array.from(document.querySelectorAll('.section__hero-left .section__hero-item'))
        if (colorSrcs.length > 0) {
          heroItems.forEach((slot, idx) => {
            const imgEl = slot.querySelector('img')
            if (!imgEl) return
            if (idx < colorSrcs.length) {
              imgEl.src = colorSrcs[idx]
              slot.style.display = ''
            } else {
              slot.style.display = 'none'
            }
          })
        }

        updateActionButtons()
      })

      document.addEventListener('keydown', function (ev) {
        const focused = document.activeElement
        if (!focused || !focused.classList.contains('color-group')) return
        if (ev.key === 'Enter' || ev.key === ' ') { 
          ev.preventDefault()
          focused.click()
        }
      })

      // ‚úÖ INITIAL SETUP
        if (Object.keys(colorSizesMap).length === 0) {
        // Kh√¥ng c√≥ m√†u - s·ª≠ d·ª•ng default sizes
        console.log('üì¶ No color options, using default sizes')
        attachSizeHandlers()
        
        setTimeout(() => {
            const defaultM = document.querySelector('[data-size="M"]')
            const firstSize = document.querySelector('.section__form-size')
            const defaultSizeBtn = defaultM || firstSize

            if (defaultSizeBtn) {
            const parent = defaultSizeBtn.closest('.section__form-button')
            if (parent) parent.classList.add('active')
            defaultSizeBtn.classList.add('active')
            defaultSizeBtn.setAttribute('aria-pressed', 'true')
            selectedSize = defaultSizeBtn.dataset.size || null
            selectedSizeId = defaultSizeBtn.dataset.sizeId || null
            if (addBtn && selectedSize) addBtn.textContent = `ADD TO CART - ${selectedSize}`
            }
            updateActionButtons()
        }, 100)
        } else {
        // ‚úÖ C√ì NHI·ªÄU M√ÄU - T√åM M√ÄU "Default" TRONG colorSizesMap
        setTimeout(() => {
            console.log('üîç Looking for Default color...')
            console.log('üìã Available colors in map:', Object.keys(colorSizesMap))
            
            // T√¨m m√†u "Default" tr·ª±c ti·∫øp trong colorSizesMap (exact match)
            let defaultColorName = null
            
            // Th·ª≠ t√¨m "Default" (case-sensitive v√¨ keys trong object ph√¢n bi·ªát hoa th∆∞·ªùng)
            if (colorSizesMap['Default']) {
            defaultColorName = 'Default'
            console.log('‚úÖ Found "Default" color in map')
            } else if (colorSizesMap['default']) {
            defaultColorName = 'default'
            console.log('‚úÖ Found "default" color in map')
            } else {
            // N·∫øu kh√¥ng t√¨m th·∫•y, d√πng m√†u ƒë·∫ßu ti√™n
            const firstColor = Object.keys(colorSizesMap)[0]
            defaultColorName = firstColor
            console.log('‚ö†Ô∏è Default color not found, using first color:', firstColor)
            }
            
            // ‚úÖ QUAN TR·ªåNG: Kh√¥ng c·∫ßn t√¨m color-group trong DOM
            // Ch·ªâ c·∫ßn render sizes tr·ª±c ti·∫øp t·ª´ colorSizesMap
            if (defaultColorName && colorSizesMap[defaultColorName]) {
            selectedColor = defaultColorName
            console.log('üéØ Auto-selected color:', selectedColor)
            
            // Render sizes cho m√†u Default ngay l·∫≠p t·ª©c
            renderSizesForColor(selectedColor)
            
            // T√¨m v√† active color-group trong DOM (n·∫øu c√≥)
            const allColorGroups = document.querySelectorAll('.color-group')
            allColorGroups.forEach(group => {
                const colorName = (group.dataset.color || '').trim()
                if (colorName === defaultColorName) {
                group.classList.add('active')
                console.log('‚úÖ Activated color-group in DOM:', colorName)
                }
            })
            
            updateActionButtons()
            } else {
            console.error('‚ùå Could not find default color in map')
            }
        }, 100)
        }

      function validateAndCollect() {
        const hasColorOptions = document.querySelectorAll('.color-group').length > 0
        
        if (hasColorOptions && !selectedColor) {
          showDialog('Vui l√≤ng ch·ªçn m√†u tr∆∞·ªõc.')
          return null
        }
        
        if (!selectedSize) {
          showDialog('Vui l√≤ng ch·ªçn size.')
          return null
        }
        
        return {
          id: productId,
          name: productName,
          price: productPrice,
          img: productImg,
          size: selectedSize,
          sizeId: selectedSizeId,
          color: selectedColor,
          quantity: 1
        }
      }

      window.addToCartDetail = function () {
        const payload = validateAndCollect()
        if (!payload) return
        if (typeof addToCart === 'function') {
          addToCart(payload)
        } else {
          console.warn('addToCart function not defined')
        }
      }

      if (addBtn) {
        addBtn.addEventListener('click', function (e) {
          const enabled = addBtn.getAttribute('aria-disabled') === 'false'
          if (!enabled) { 
            e.preventDefault()
            validateAndCollect()
            return
          }
          window.addToCartDetail()
        })
      }

      if (buyBtn) {
        buyBtn.addEventListener('click', function (e) {
          const enabled = buyBtn.getAttribute('aria-disabled') === 'false'
          if (!enabled) { 
            e.preventDefault()
            validateAndCollect()
            return
          }
          window.addToCartDetail()
        })
      }

      updateActionButtons()
      
    } catch (err) {
      console.error('detail page script error:', err)
    }
  })
})()
</script>