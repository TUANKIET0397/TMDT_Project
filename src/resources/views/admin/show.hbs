{{#contentFor "styleadmin"}}
    <link rel="stylesheet" href="/css/listProduct.css" />
{{/contentFor}}

{{! List product }}
<main class="main-content">
    <div class="header">
        <div class="header_search-box">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" class="header_search-input" placeholder=" Search product">
        </div>
        <div class="filer_box">
            <i class="fa-solid fa-filter"></i>
            <select id="filter" onchange="filterType()">
                <option value="" {{#if (eq selectedType "")}}selected{{/if}}>Filter</option>
                {{#each types}}
                    <option value="{{this.TypeName}}" {{#if (eq ../selectedType this.TypeName)}}selected{{/if}}>
                        {{this.TypeName}}
                    </option>
                {{/each}}
            </select>
        </div>
        <a href="/admin/create" class="add_page">+ Add</a>
    </div>
    <div id="flash-message" class="flash-message" hidden></div>
    
    <div class="product-grid">
        {{#each products}}
            <div class="product-card" data-product-id="{{this.ID}}">
                {{!-- Link to detail page với ID sản phẩm --}}
                <a href="/admin/detail/{{this.ID}}" class="detail_page">
                    <div class="product-image">
                        <div class="quantity-badge">
                            {{this.QuantityValue}}
                        </div>
                        <img src="{{#if this.ImgPath}}{{this.ImgPath}}{{else}}/img/product-other1.png{{/if}}" alt="{{this.ProductName}}">
                    </div>
                    <div class="product-info">
                        <div class="name_price">
                            <div class="product-name">{{this.ProductName}}</div>
                            <div class="product-price">{{this.Price}}$</div>
                        </div>
                        <div class="product-des">{{this.Descriptions}}</div>
                    </div>
                </a>
                <form action="/products/{{this.ID}}/delete" method="POST" class="delete-form">
                    <button type="submit" class="delete-btn">
                        <i class="fa-solid fa-trash"></i>
                        Delete
                    </button>
                </form>
            </div>
        {{/each}}
    </div>
</main>

<script>
    function filterType() {
        const type = document.getElementById('filter').value
        window.location.href = `/admin/show${type ? '?type=' + encodeURIComponent(type) : ''}`
    }

    ;(() => {
        const forms = document.querySelectorAll('.delete-form')
        const flashBox = document.getElementById('flash-message')
        let flashTimer

        function showFlash(message, isError = false) {
            if (!flashBox) return
            flashBox.textContent = message
            flashBox.classList.toggle('error', Boolean(isError))
            flashBox.hidden = false
            if (flashTimer) {
                clearTimeout(flashTimer)
            }
            flashTimer = setTimeout(() => {
                flashBox.hidden = true
            }, 3000)
        }

        forms.forEach((form) => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault()
                const confirmed = window.confirm('Delete this product?')
                if (!confirmed) return

                const card = form.closest('.product-card')
                const formData = new FormData(form)

                try {
                    const response = await fetch(form.action, {
                        method: form.method || 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        body: new URLSearchParams(formData),
                    })

                    if (!response.ok) {
                        throw new Error('Failed to delete product.')
                    }

                    const data = await response.json().catch(() => ({}))
                    if (!data.success) {
                        throw new Error(data.message || 'Delete failed.')
                    }

                    if (card) {
                        card.classList.add('removed')
                        setTimeout(() => {
                            card.remove()
                        }, 2500)
                    }
                    showFlash(data.message || 'Product has been deleted.')
                } catch (error) {
                    console.error(error)
                    showFlash(error.message || 'Failed to delete product.', true)
                }
            })
        })
    })()
</script>