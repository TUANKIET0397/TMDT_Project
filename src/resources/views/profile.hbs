{{#contentFor "styles"}}
<link rel="stylesheet" href="/css/profile.css" />
{{/contentFor}}

<div class="profile-page">
  {{#if notice}}
  <div class="profile-alert"
    style="background:#fff9c4;border:1px solid #f6e05e;padding:12px 16px;border-radius:8px;margin-bottom:16px;color:#744210;">
    {{notice}}
    {{#if missingFieldsDisplay}}
    <br />
    <strong>Thiếu:</strong>
    {{#each missingFieldsDisplay}}
    {{this}}{{#unless @last}}, {{/unless}}
    {{/each}}
    {{/if}}
  </div>
  {{/if}}
  <input type="radio" name="tab" id="tab-profile" {{#unless isOrders}}checked{{/unless}} />
  <input type="radio" name="tab" id="tab-orders" {{#if isOrders}}checked{{/if}} />

  <div class="tab-header">
    <div class="user-summary">
      <div class="user-avatar">
        {{#if user.Avt}}
        <img src="/uploads/users/{{user.Avt}}" alt="avatar"
          style="width:48px;height:48px;border-radius:50%" />
        {{/if}}
      </div>
      <div class="user-info">
        <strong>{{user.FirstName}} {{user.LastName}}</strong>
        <!-- Edit button: click to enable editing -->
        <div class="user-actions">
          <button id="editProfileBtn" type="button" class="btn btn-link">Edit
            profile</button>
          <button id="saveProfileBtn" type="button" class="btn btn-primary"
            style="display:none">Save</button>
          <button id="cancelEditBtn" type="button" class="btn"
            style="display:none">Cancel</button>
          <form id="logoutForm" action="/auth/logout" method="POST" style="display:inline">
            <button id="logoutBtn" type="button" class="btn btn-logout">Logout</button>
          </form>
        </div>
      </div>
    </div>

    <label for="tab-profile">Profile of user</label>
    <label for="tab-orders">Order Purchases</label>
  </div>

  <div class="tab-content profile">
    <form class="profile-form" method="POST" action="/profile/update">
      <input type="hidden" name="redirectTo" value="{{redirectTo}}" />
      <div>
        <div class="field-label">First name</div>
        <input name="FirstName" class="field-input editable"
          value="{{user.FirstName}}" disabled />
      </div>

      <div>
        <div class="field-label">Last name</div>
        <input name="LastName" class="field-input editable"
          value="{{user.LastName}}" disabled />
      </div>

      <div>
        <div class="field-label">ID</div>
        <input name="ID" class="field-input" value="{{user.ID}}" readonly />
      </div>

      <div>
        <div class="field-label">Birth date</div>
        <input type="date" name="BirthDate" class="field-input editable"
          value="{{user.BirthDate}}" disabled />
      </div>
      <div class="field-span-2">

        <div class="field-label">Address</div>
        <input name="Address" class="field-input editable"
          value="{{user.Address}}" disabled />
      </div>

      <div>
        <div class="field-label">Phone number</div>
        <input name="PhoneNumber" class="field-input editable"
          value="{{user.PhoneNumber}}" disabled />
      </div>

      <div class="field-span-2">
        <div class="field-label">Email</div>
        <input name="Email" class="field-input editable" value="{{user.Email}}"
          disabled />
      </div>

      <div class="full-width">
        <div class="field-label">Gender</div>
        <input name="Gender" class="field-input editable"
          value="{{user.Gender}}" disabled />

      </div>

      <div>
        <div class="field-label">Region</div>
        <select name="RegionID" class="field-select editable region-select"
          disabled>
          <option value="" hidden selected ></option>
          {{#each regions}}
          <option value="{{ID}}" {{#if selected}} selected{{/if}}>
            {{RegionName}}
          </option>
          {{/each}}
        </select>
      </div>
    </form>
  </div>

  <div class="tab-content orders">
    <table class="orders-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Quantity types</th>
          <th>Dates</th>
          <th>Costs</th>
          <th>Payment</th>
          <th>Status</th>
        </tr>
      </thead>
            <tbody>
              {{#each orders}}
                <tr class="order-row" data-detail="detail-{{id}}" style="cursor: pointer;">
                  <td class="order-id">
                    <span class="order-arrow">˅</span>
                    <span>#{{id}}</span>
                  </td>
                  <td>{{quantityTypes}}</td>
                  <td>{{createdAt}}</td>
                  <td>${{totalCost}}</td>
                  <td style="color: {{#if (eq this.payment 'Paid')}}#28a745{{else}}#ffc107{{/if}}; font-weight: 600;">
                    {{payment}}
                  </td>
                  <td style="color: {{#if (eq this.states 'Delivered')}}#28a745{{else if (eq this.states 'Cancelled')}}#e53e3e{{else if (eq this.states 'Prepare')}}#ffc107{{else}}#667eea{{/if}};">
                    {{states}}
                  </td>
                </tr>

                <tr id="detail-{{id}}" class="order-detail-row" style="display:none">
                  <td colspan="6">
                    <div style="background: #f8f9fa; border-radius: 2px; padding: 1px">
                      <div class="detail-header">
                        <span>Product Details</span>
                        <span style="text-align: center;">Quantity</span>
                        <span style="text-align: right;">Total Price</span>
                      </div>

                      {{!-- HIỆN CHI TIẾT ITEMS CỦA TỪNG ORDER --}}
                      {{#each items}}
                        <div class="detail-item">
                          <div class="detail-info">
                            <img src="{{productImage}}" alt="{{productName}}"/>
                            <div style="flex: 1; padding-right: 85px;">
                              <p>{{productName}}</p>
                              <p>Unit Price: ${{unitPrice}}</p>
                            </div>
                          </div>
                          <div class="detail-qty">x{{qty}}</div>
                          <div class="detail-cost">${{totalPrice}}</div>
                        </div>
                      {{else}}
                        <p style="text-align: center; color: #999; padding: 20px;">
                          No items in this order
                        </p>
                      {{/each}}

                    </div>
                  </td>
                </tr>
              {{else}}
                <tr>
                  <td colspan="6" style="text-align:center; color:#999; padding:20px;">
                    You have no orders yet
                  </td>
                </tr>
              {{/each}}
            </tbody>

    </table>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('[profile] DOMContentLoaded')

    const editBtn = document.getElementById('editProfileBtn')
    const saveBtn = document.getElementById('saveProfileBtn')
    const cancelBtn = document.getElementById('cancelEditBtn')
    const logoutBtn = document.getElementById('logoutBtn')
    const logoutForm = document.getElementById('logoutForm')
    const form = document.querySelector('.profile-form')
    const editables = Array.from(document.querySelectorAll('.profile-form .editable'))
    const regionSelect = document.querySelector('.region-select')

    // Init tab from query / hash
    try {
      const params = new URLSearchParams(window.location.search)
      const tabParam = (params.get('tab') || '').toLowerCase()
      const hash = (window.location.hash || '').replace('#', '').toLowerCase()
      console.log('[profile] initTabFromQuery', { tabParam, hash })
      if (tabParam === 'orders' || hash === 'orders') {
        const ordersRadio = document.getElementById('tab-orders')
        if (ordersRadio) ordersRadio.checked = true
      }
    } catch (e) {
      console.warn('[profile] initTabFromQuery error', e)
    }

    // Save original values
    editables.forEach(el => {
      el.dataset._orig = el.value
    })

    function setEditable(enabled) {
      editables.forEach(el => {
        el.disabled = !enabled
      })

      if (editBtn) editBtn.style.display = enabled ? 'none' : ''
      if (saveBtn) saveBtn.style.display = enabled ? '' : 'none'
      if (cancelBtn) cancelBtn.style.display = enabled ? '' : 'none'

      if (regionSelect) {
        regionSelect.disabled = !enabled
        if (!enabled) {
          regionSelect.blur()
        } else {
          regionSelect.focus()
        }
      }
    }

    if (editBtn) {
      editBtn.addEventListener('click', function () {
        editables.forEach(el => { el.dataset._orig = el.value })
        setEditable(true)
        const first = editables.find(e => !e.disabled)
        if (first) first.focus()
      })
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('click', function () {
        editables.forEach(el => {
          if (el.dataset._orig !== undefined) el.value = el.dataset._orig
          el.disabled = true
        })
        setEditable(false)
      })
    }

    if (saveBtn) {
      saveBtn.addEventListener('click', function () {
        if (form) form.submit()
      })
    }

    if (logoutBtn) {
      logoutBtn.addEventListener('click', async function (e) {
        const ok = confirm('Bạn có muốn đăng xuất không?')
        if (!ok) return

        try {
          const res = await fetch('/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({})
          })
          if (res.ok) {
            try {
              const json = await res.json()
              window.location.href = json.redirect || '/'
            } catch (_) {
              window.location.href = '/'
            }
            return
          }
        } catch (err) {
          // fallback to form submit if fetch fails
        }
        if (logoutForm) logoutForm.submit()
      })
    }

    // initial region view: display values only
    if (regionSelect) regionSelect.disabled = true

    // order row toggle -- event delegation on table for robustness
    const ordersTable = document.querySelector('.orders-table')
    if (ordersTable) {
      ordersTable.addEventListener('click', function (e) {
        const row = e.target.closest('.order-row')
        if (!row) return

        const targetId = row.getAttribute('data-detail')
        if (!targetId) return

        const detailRow = document.getElementById(targetId)
        if (!detailRow) return

        const isOpen = row.classList.contains('open')
        if (isOpen) {
          row.classList.remove('open')
          detailRow.style.display = 'none'
        } else {
          row.classList.add('open')
          detailRow.style.display = 'table-row'
        }
      })
    }

    // Debug: confirm event hookup
    console.log('[profile] events bound', {
      editBound: !!editBtn,
      saveBound: !!saveBtn,
      logoutBound: !!logoutBtn,
      ordersTableBound: !!ordersTable
    })
  })
</script>