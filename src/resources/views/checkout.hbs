{{#contentFor "payment"}}
    <link rel="stylesheet" href="/css/checkout.css" />
    <script>
        // MoMo payment handler
        document.addEventListener('DOMContentLoaded', function() {
            const momoBtn = document.querySelector('.checkout__btn')
            const form = document.querySelector('.checkout__form')
            if (!momoBtn || !form) return

            let statusDiv
            const showStatus = (message, type = 'info') => {
                if (!statusDiv) {
                    statusDiv = document.createElement('div')
                    statusDiv.id = 'paymentStatus'
                    statusDiv.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); color:white; padding:15px 30px; border-radius:8px; z-index:9999; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.15);'
                    document.body.appendChild(statusDiv)
                }
                statusDiv.style.background = type === 'error' ? '#e53e3e' : '#667eea'
                statusDiv.textContent = message

                if (type === 'error') {
                    clearTimeout(statusDiv._hideTimer)
                    statusDiv._hideTimer = setTimeout(() => {
                        statusDiv.remove()
                        statusDiv = null
                    }, 4000)
                }
            }

            const ensureCartInput = () => {
                let cartDataInput = form.querySelector('input[name="cartData"]')
                if (!cartDataInput) {
                    cartDataInput = document.createElement('input')
                    cartDataInput.type = 'hidden'
                    cartDataInput.name = 'cartData'
                    form.appendChild(cartDataInput)
                }
                return cartDataInput
            }

            momoBtn.addEventListener('click', function(e) {
                e.preventDefault()

                const requiredFields = [
                    { selector: '.firstName', label: 'First name' },
                    { selector: '.lastName', label: 'Last name' },
                    { selector: '.checkout__address', label: 'Address' },
                    { selector: '.checkout__phone', label: 'Phone number' },
                ]

                const missingFields = requiredFields
                    .filter(({ selector }) => {
                        const input = form.querySelector(selector)
                        return !input || !input.value.trim()
                    })
                    .map((field) => field.label)

                const regionSelect = form.querySelector('select[name="RegionID"]')
                if (!regionSelect || !regionSelect.value) {
                    missingFields.push('Region')
                }

                if (missingFields.length > 0) {
                    showStatus(
                        `Vui lòng điền: ${missingFields.join(', ')}`,
                        'error'
                    )
                    return
                }

                const cartDataInput = ensureCartInput()
                if (!cartDataInput.value) {
                    try {
                        const storedCart = localStorage.getItem('cart')
                        cartDataInput.value = storedCart || '[]'
                    } catch (storageErr) {
                        console.error('Cannot read cart from localStorage', storageErr)
                        cartDataInput.value = '[]'
                    }
                }

                let parsedCart = []
                try {
                    parsedCart = JSON.parse(cartDataInput.value || '[]')
                } catch (parseErr) {
                    console.error('Invalid cart data in checkout', parseErr)
                    showStatus('Giỏ hàng không hợp lệ, vui lòng thử lại.', 'error')
                    return
                }

                if (!Array.isArray(parsedCart) || parsedCart.length === 0) {
                    showStatus('Giỏ hàng trống. Vui lòng thêm sản phẩm.', 'error')
                    return
                }

                showStatus('⏳ Đang kết nối với MoMo...')

                const totalAmount = document
                    .querySelector('.checkout__total-price')
                    ?.textContent?.replace('$', '')
                    .trim() || '0'

                const existingPaymentType = form.querySelector('input[name="paymentType"]')
                if (existingPaymentType) existingPaymentType.remove()
                const existingAmount = form.querySelector('input[name="amount"]')
                if (existingAmount) existingAmount.remove()

                const paymentTypeInput = document.createElement('input')
                paymentTypeInput.type = 'hidden'
                paymentTypeInput.name = 'paymentType'
                paymentTypeInput.value = 'momo'
                form.appendChild(paymentTypeInput)

                const amountInput = document.createElement('input')
                amountInput.type = 'hidden'
                amountInput.name = 'amount'
                amountInput.value = totalAmount
                form.appendChild(amountInput)

                form.action = '/payment'
                form.method = 'POST'
                form.submit()
            })
        })
    </script>
{{/contentFor}}
{{! Checkout }}
<main class="checkout">

    <form class="checkout__form" action="/checkout" method="get">
        <input
            type="hidden"
            name="cartData"
            id="checkoutCartData"
            value='{{#if cartDataJson}}{{{cartDataJson}}}{{else}}[]{{/if}}'
        />

        <div class="checkout-wrap">
            <!-- Form Sign Up Delivery -->
            <section class="checkout__left">
                <div class="checkout__left-label">Express checkout</div>
                <div class="checkout__btn">
                    <img
                        src="img/momo.png"
                        alt="MoMo"
                        class="checkout__brand-momo"
                    />
                </div>
                <div class="checkout__aside">Or</div>
                <p class="checkout__info">{{#if user}}{{user.Email}}{{else}}Not logged in{{/if}}</p>
                <h2 class="checkout__heading">Delivery</h2>
                <select
                    class="checkout__country"
                    name="RegionID"
                    id="country"
                    required
                >
                    <option
                        value=""
                        disabled
                        {{#unless user.RegionID}}selected{{/unless}}
                        hidden
                    >Country/Region</option>
                    {{#if regions}}
                        {{#each regions}}
                            <option
                                value="{{ID}}"
                                {{#if selected}}selected{{/if}}
                            >{{RegionName}}</option>
                        {{/each}}
                    {{else}}
                        <option value="" disabled>No regions available</option>
                    {{/if}}
                </select>
                <div class="checkout__fullname">
                    <input
                        class="firstName"
                        type="text"
                        name="first_name"
                        placeholder="First Name"
                        value="{{#if user}}{{user.FirstName}}{{/if}}"
                        required
                    />
                    <input
                        class="lastName"
                        type="text"
                        name="last_name"
                        placeholder="Last Name"
                        value="{{#if user}}{{user.LastName}}{{/if}}"
                        required
                    />
                </div>
                <input
                    class="checkout__address"
                    type="text"
                    name="address"
                    placeholder="Address"
                    value="{{#if user}}{{user.Address}}{{/if}}"
                    required
                />
                <div class="checkout__zipcode">
                    <input
                        class="checkout__post"
                        type="text"
                        name="post code"
                        placeholder="Post code"
                        required
                    />
                    <input
                        class="checkout__city"
                        type="text"
                        name="city"
                        placeholder="City"
                        required
                    />
                </div>
                <input
                    class="checkout__phone"
                    type="text"
                    name="phone_number"
                    placeholder="Phone number"
                    value="{{#if user}}{{user.PhoneNumber}}{{/if}}"
                    required
                />
                <h3 class="checkout__title-payment">Direct payment</h3>
                <button class="checkout__btn-payment" type="submit">Order now</button>
                <p class="checkout__desc-rule">
                    Your info will be saved to a Shop account. By continuing,
                    you agree to Shop's
                    <span class="underline"> Terms of Service</span>
                    and acknowledge the
                    <span class="underline">Privacy Policy</span>.
                </p>
            </section>

            <!-- The number of products -->
            <div class="checkout__right">
                <div class="Box-list">
                    {{#if cartItems}}
                        {{#each cartItems}}
                            <div class="Box__wrap-item">
                                <div class="wrap-img--item">
                                    <img
                                        class="box__wrap-img"
                                        src="{{this.img}}"
                                        alt="{{this.name}}"
                                    />
                                    <div
                                        class="box__wrap-img--numberDecord"
                                    >{{this.quantity}}</div>
                                </div>
                                <div class="box__inner-small">
                                    <p class="box-desc">{{this.name}}</p>
                                    <p class="box-size">{{#if
                                            this.size
                                        }}{{this.size}}{{else}}N/A{{/if}}</p>
                                </div>
                                <p class="box-price">${{this.price}}</p>
                            </div>
                        {{/each}}
                    {{else}}
                        <p
                            style="grid-column:1/-1; text-align:center; padding:20px; color:#666;"
                        >No items in cart</p>
                    {{/if}}
                </div>
                <div class="checkout__discount">
                    <input
                        type="text"
                        id="discountCode"
                        placeholder="Discount code or gift card"
                    />
                    <button type="button" class="applyDiscount">Apply</button>
                </div>
                <div class="checkout__summary-item">Subtotal -
                    {{itemCount}}
                    item{{#unless (eq itemCount 1)}}s{{/unless}}</div>
                <div class="checkout__total">
                    <p class="checkout__total-label">Total</p>
                    <div class="checkout__total-price">${{subtotal}}</div>
                </div>
                <p class="checkout__summary-desc">Including taxes (if any)</p>
            </div>
        </div>
    </form>

</main>