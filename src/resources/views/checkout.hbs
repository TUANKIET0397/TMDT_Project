{{#contentFor "payment"}}
    <link rel="stylesheet" href="/css/checkout.css" />
    <script>
        // MoMo payment handler
        document.addEventListener('DOMContentLoaded', function() {
            const momoBtn = document.querySelector('.checkout__btn')
            if (momoBtn) {
                momoBtn.addEventListener('click', function(e) {
                    e.preventDefault()
                    const form = document.querySelector('.checkout__form')
                    
                    // Show loading status
                    const statusDiv = document.createElement('div')
                    statusDiv.id = 'paymentStatus'
                    statusDiv.style.cssText = 'position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#667eea; color:white; padding:15px 30px; border-radius:8px; z-index:9999; font-weight:600; box-shadow:0 4px 12px rgba(0,0,0,0.15);'
                    statusDiv.textContent = '⏳ Đang kết nối với MoMo...'
                    document.body.appendChild(statusDiv)
                    
                    // Get total amount from price display
                    const totalAmount = document.querySelector('.checkout__total-price')?.textContent?.replace('$', '').trim() || '0'
                    
                    // Remove any existing hidden inputs for payment (to avoid duplicates)
                    const existingPaymentType = form.querySelector('input[name="paymentType"]')
                    if (existingPaymentType) existingPaymentType.remove()
                    const existingAmount = form.querySelector('input[name="amount"]')
                    if (existingAmount) existingAmount.remove()
                    
                    // Create hidden input for payment type
                    const paymentTypeInput = document.createElement('input')
                    paymentTypeInput.type = 'hidden'
                    paymentTypeInput.name = 'paymentType'
                    paymentTypeInput.value = 'momo'
                    form.appendChild(paymentTypeInput)
                    
                    // Create hidden input for amount
                    const amountInput = document.createElement('input')
                    amountInput.type = 'hidden'
                    amountInput.name = 'amount'
                    amountInput.value = totalAmount
                    form.appendChild(amountInput)
                    
                    // Change form action and submit
                    form.action = '/payment'
                    form.method = 'POST'
                    form.submit()
                })
            }
        })
    </script>
{{/contentFor}}
{{! Checkout }}
<main class="checkout">

    <form class="checkout__form" action="/checkout" method="get">

        <div class="checkout-wrap">
            <!-- Form Sign Up Delivery -->
            <section class="checkout__left">
                <div class="checkout__left-label">Express checkout</div>
                <div class="checkout__btn">
                    <img
                        src="img/momo.png"
                        alt="MoMo"
                        class="checkout__brand-momo"
                    />
                </div>
                <div class="checkout__aside">Or</div>
                <p class="checkout__info">{{#if user}}{{user.Email}}{{else}}Not logged in{{/if}}</p>
                <h2 class="checkout__heading">Delivery</h2>
                <select
                    class="checkout__country"
                    name="country"
                    id="country"
                    required
                >
                    <option
                        value=""
                        disabled
                        {{#unless user}}selected{{/unless}}
                        hidden
                    >Country/Region</option>
                    <option value="1" {{#if (eq user.Region "1")}}selected{{/if}}>TP Hồ Chí Minh</option>
                    <option value="2" {{#if (eq user.Region "2")}}selected{{/if}}>Cà Mau</option>
                    <option value="3" {{#if (eq user.Region "3")}}selected{{/if}}>Hà Nội</option>
                    <option value="4" {{#if (eq user.Region "4")}}selected{{/if}}>Hà Nội</option>
                    <option value="5" {{#if (eq user.Region "5")}}selected{{/if}}>Hà Nội</option>
                    <option value="6" {{#if (eq user.Region "6")}}selected{{/if}}>Hà Nội</option>
                    <option value="7" {{#if (eq user.Region "7")}}selected{{/if}}>Hà Nội</option>
                    <option value="8" {{#if (eq user.Region "8")}}selected{{/if}}>Hà Nội</option>
                    <option value="9" {{#if (eq user.Region "9")}}selected{{/if}}>Hà Nội</option>
                    <option value="10" {{#if (eq user.Region "10")}}selected{{/if}}>Hà Nội</option>
                </select>
                <div class="checkout__fullname">
                    <input
                        class="firstName"
                        type="text"
                        name="first_name"
                        placeholder="First Name"
                        value="{{#if user}}{{user.FirstName}}{{/if}}"
                        required
                    />
                    <input
                        class="lastName"
                        type="text"
                        name="last_name"
                        placeholder="Last Name"
                        value="{{#if user}}{{user.LastName}}{{/if}}"
                        required
                    />
                </div>
                <input
                    class="checkout__address"
                    type="text"
                    name="address"
                    placeholder="Address"
                    value="{{#if user}}{{user.Address}}{{/if}}"
                    required
                />
                <div class="checkout__zipcode">
                    <input
                        class="checkout__post"
                        type="text"
                        name="post code"
                        placeholder="Post code"
                        required
                    />
                    <input
                        class="checkout__city"
                        type="text"
                        name="city"
                        placeholder="City"
                        required
                    />
                </div>
                <input
                    class="checkout__phone"
                    type="text"
                    name="phone_number"
                    placeholder="Phone number"
                    value="{{#if user}}{{user.PhoneNumber}}{{/if}}"
                    required
                />
                <h3 class="checkout__title-payment">Direct payment</h3>
                <button class="checkout__btn-payment" type="submit">Order now</button>
                <p class="checkout__desc-rule">
                    Your info will be saved to a Shop account. By continuing,
                    you agree to Shop's
                    <span class="underline"> Terms of Service</span>
                    and acknowledge the
                    <span class="underline">Privacy Policy</span>.
                </p>
            </section>

            <!-- The number of products -->
            <div class="checkout__right">
                <div class="Box-list">
                    {{#if cartItems}}
                        {{#each cartItems}}
                            <div class="Box__wrap-item">
                                <div class="wrap-img--item">
                                    <img
                                        class="box__wrap-img"
                                        src="{{this.img}}"
                                        alt="{{this.name}}"
                                    />
                                    <div
                                        class="box__wrap-img--numberDecord"
                                    >{{this.quantity}}</div>
                                </div>
                                <div class="box__inner-small">
                                    <p class="box-desc">{{this.name}}</p>
                                    <p class="box-size">{{#if
                                            this.size
                                        }}{{this.size}}{{else}}N/A{{/if}}</p>
                                </div>
                                <p class="box-price">${{this.price}}</p>
                            </div>
                        {{/each}}
                    {{else}}
                        <p
                            style="grid-column:1/-1; text-align:center; padding:20px; color:#666;"
                        >No items in cart</p>
                    {{/if}}
                </div>
                <div class="checkout__discount">
                    <input
                        type="text"
                        id="discountCode"
                        placeholder="Discount code or gift card"
                    />
                    <button type="button" class="applyDiscount">Apply</button>
                </div>
                <div class="checkout__summary-item">Subtotal -
                    {{itemCount}}
                    item{{#unless (eq itemCount 1)}}s{{/unless}}</div>
                <div class="checkout__total">
                    <p class="checkout__total-label">Total</p>
                    <div class="checkout__total-price">${{subtotal}}</div>
                </div>
                <p class="checkout__summary-desc">Including taxes (if any)</p>
            </div>
        </div>
    </form>

</main>